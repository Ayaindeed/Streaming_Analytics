<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Analytics Dashboard - Real-time Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 70%, rgba(14, 165, 233, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 70% 30%, rgba(168, 85, 247, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(30, 27, 75, 0.85);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3),
                        0 0 80px rgba(168, 85, 247, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
            backdrop-filter: blur(30px);
            border: 1px solid rgba(168, 85, 247, 0.2);
            position: relative;
            z-index: 1;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(5%, 5%); }
        }

        .dashboard-header h1 {
            font-size: 2.8em;
            font-weight: 800;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            letter-spacing: -1px;
        }

        .dashboard-header p {
            font-size: 1.2em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            padding: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(88, 28, 135, 0.3) 0%, rgba(49, 46, 129, 0.3) 100%);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 20px 40px rgba(168, 85, 247, 0.3);
            border-color: rgba(168, 85, 247, 0.5);
            background: linear-gradient(135deg, rgba(88, 28, 135, 0.5) 0%, rgba(49, 46, 129, 0.5) 100%);
        }

        .stat-number {
            font-size: 3.2em;
            font-weight: 800;
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            color: #c4b5fd;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .content-section {
            padding: 40px;
        }

        .section-title {
            font-size: 2em;
            background: linear-gradient(135deg, #e9d5ff 0%, #fae8ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .data-table th,
        .data-table td {
            padding: 18px 24px;
            text-align: left;
            border-bottom: 1px solid rgba(168, 85, 247, 0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white;
            font-weight: 700;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tr:nth-child(even) {
            background-color: rgba(88, 28, 135, 0.15);
        }

        .data-table tr:hover {
            background-color: rgba(168, 85, 247, 0.2);
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        .data-table td {
            color: #e2e8f0;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-container {
            background: linear-gradient(135deg, rgba(88, 28, 135, 0.3) 0%, rgba(49, 46, 129, 0.3) 100%);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.2);
            position: relative;
            height: 350px;
            min-height: 300px;
        }

        .recommendation-card {
            background: linear-gradient(135deg, rgba(88, 28, 135, 0.3) 0%, rgba(49, 46, 129, 0.3) 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #a855f7;
            transition: all 0.3s ease;
        }

        .recommendation-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 16px rgba(168, 85, 247, 0.3);
            border-left-color: #ec4899;
        }

        .recommendation-card h3 {
            color: #e9d5ff;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .recommendation-card p {
            color: #c4b5fd;
            font-size: 0.95em;
            margin: 5px 0;
        }

        .recommendation-card em {
            color: #9f7aea;
            display: block;
            margin-top: 8px;
            font-style: italic;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .back-link {
            display: inline-block;
            margin: 20px 40px;
            color: #c4b5fd;
            text-decoration: none;
            font-weight: 600;
            padding: 12px 28px;
            border-radius: 12px;
            border: 2px solid rgba(168, 85, 247, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(168, 85, 247, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 2;
        }

        .back-link:hover {
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            color: white;
            transform: translateX(-5px);
            box-shadow: 0 8px 20px rgba(168, 85, 247, 0.4);
            border-color: transparent;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
                padding: 20px;
            }

            .content-section {
                padding: 20px;
            }

            .dashboard-header {
                padding: 30px 20px;
            }

            .dashboard-header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <a href="../" class="back-link">← Back to Home</a>

    <!-- Previous styles remain the same -->

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Streaming Analytics Dashboard</h1>
            <p>Real-time analytics and insights</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">${totalVideos}</div>
                <div class="stat-label">Videos cataloguées</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${totalUsers}</div>
                <div class="stat-label">Utilisateurs actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${totalViews}</div>
                <div class="stat-label">Vues totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${avgWatchTime}</div>
                <div class="stat-label">Durée moyenne de visionnage</div>
            </div>
        </div>

        <div class="content-section">
            <h2 class="section-title">Top 10 Videos</h2>
            <table class="data-table">
                <thead>
                <tr>
                    <th>Titre</th>
                    <th>Vues</th>
                    <th>Likes</th>
                    <th>Durée moyenne</th>
                    <th>Engagement</th>
                </tr>
                </thead>
                <tbody>
                <c:forEach var="video" items="${topVideos}">
                    <tr>
                        <td>${video.title}</td>
                        <td>${video.totalViews}</td>
                        <td>${video.totalLikes}</td>
                        <td>${video.avgDuration}s</td>
                        <td>${video.engagementRate}%</td>
                    </tr>
                </c:forEach>
                </tbody>
            </table>
        </div>

        <div class="content-section">
            <h2 class="section-title">Statistiques en temps réel</h2>
            <div id="realtime-stats" class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="current-viewers">0</div>
                    <div class="stat-label">Spectateurs actuels</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="events-per-second">0</div>
                    <div class="stat-label">Événements/seconde</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-users">0</div>
                    <div class="stat-label">Utilisateurs actifs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="most-watched">N/A</div>
                    <div class="stat-label">Vidéo la plus regardée</div>
                </div>
            </div>
        </div>

        <div class="content-section">
            <h2 class="section-title">Recommandations personnalisées</h2>
            <div style="margin-bottom: 30px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="userId" placeholder="Entrez votre ID utilisateur" 
                       style="padding: 10px; border-radius: 8px; border: 1px solid #a855f7; background: rgba(168, 85, 247, 0.1); color: #e2e8f0; flex: 1; max-width: 300px;">
                <button onclick="loadUserRecommendations()" 
                        style="padding: 10px 20px; background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Charger Recommandations
                </button>
            </div>
            <div id="recommendations-list" class="recommendations-grid">
                <div class="stat-card" style="grid-column: 1/-1;">
                    <p style="color: #c4b5fd;">Entrez votre ID utilisateur et cliquez sur "Charger Recommandations" pour voir les vidéos recommandées</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/analytics-api/api/v1/analytics';
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeRealtimeUpdates();
        });

        // Real-time SSE updates
        function initializeRealtimeUpdates() {
            try {
                const evtSource = new EventSource(API_BASE_URL + '/realtime/stream');
                
                evtSource.addEventListener('stats', function(event) {
                    try {
                        const stats = JSON.parse(event.data);
                        updateRealtimeStats(stats);
                    } catch (e) {
                        console.log('Stats event received');
                    }
                }, false);

                evtSource.onerror = function(event) {
                    console.log('SSE Connection: attempting to reconnect');
                    setTimeout(() => initializeRealtimeUpdates(), 3000);
                };
            } catch (error) {
                console.log('Real-time updates not available');
            }
        }

        // Update real-time statistics
        function updateRealtimeStats(stats) {
            if (stats.currentViewers !== undefined) {
                document.getElementById('current-viewers').textContent = formatNumber(stats.currentViewers);
            }
            if (stats.eventsPerSecond !== undefined) {
                document.getElementById('events-per-second').textContent = formatNumber(stats.eventsPerSecond);
            }
            if (stats.activeUsers !== undefined) {
                document.getElementById('active-users').textContent = formatNumber(stats.activeUsers);
            }
            if (stats.mostWatchedVideoId) {
                document.getElementById('most-watched').textContent = 'Video: ' + stats.mostWatchedVideoId;
            }
        }

        // Load recommendations for a user
        function loadUserRecommendations() {
            const userId = document.getElementById('userId').value.trim();
            
            if (!userId) {
                alert('Veuillez entrer un ID utilisateur');
                return;
            }

            const container = document.getElementById('recommendations-list');
            container.innerHTML = '<div class="stat-card" style="grid-column: 1/-1;"><p style="color: #c4b5fd;">Chargement...</p></div>';

            fetch(API_BASE_URL + '/users/' + encodeURIComponent(userId) + '/recommendations?limit=5')
                .then(response => response.json())
                .then(data => {
                    displayRecommendations(data.data || data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    container.innerHTML = '<div class="stat-card" style="grid-column: 1/-1;"><p style="color: #ff6b6b;">Erreur: ' + error.message + '</p></div>';
                });
        }

        // Display recommendations
        function displayRecommendations(recommendations) {
            const container = document.getElementById('recommendations-list');
            container.innerHTML = '';

            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<div class="stat-card" style="grid-column: 1/-1;"><p style="color: #c4b5fd;">Aucune recommandation disponible</p></div>';
                return;
            }

            recommendations.forEach((rec, index) => {
                const card = document.createElement('div');
                card.className = 'recommendation-card';
                card.innerHTML = `
                    <h3>#${index + 1} - ${rec.videoTitle || 'Video: ' + rec.videoId}</h3>
                    <p><strong>Catégorie:</strong> ${rec.category || 'N/A'}</p>
                    <p><strong>Vues:</strong> ${formatNumber(rec.views || 0)}</p>
                    <p><strong>Score de pertinence:</strong> ${((rec.relevanceScore || 0) * 100).toFixed(1)}%</p>
                    <p><strong>Raison:</strong> <em>${rec.reason || 'Recommandé pour vous'}</em></p>
                `;
                container.appendChild(card);
            });
        }

        // Format large numbers
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num).toString();
        }
    </script></body>
</html>